kind: Module
name: db
description: A Terraform module for provisioning a Google Cloud SQL database
type: terraform
include: []
variables:
  gcp_network: ${providers.terraform.outputs.gcp_network}
disabled: ${environment.name != "remote"}

---

kind: Module
description: Postgres Helm chart for development
type: helm
name: db-dev
chart: stable/postgresql
disabled: ${environment.name != "local"}
version: 5.3.11
serviceResource:
  kind: StatefulSet
  name: postgres
tasks:
  - name: db-init
    command: [/bin/sh, -c]
    # The postgres health check appears to go through before the server accepts remote connections, so we need to
    # sleep for a while.
    # https://github.com/CrunchyData/crunchy-containers/issues/653
    args: [
      "sleep 15 && psql -w -U postgres --host=postgres --port=5432 -d postgres -c 'CREATE TABLE IF NOT EXISTS users (id VARCHAR(255) NOT NULL UNIQUE, name VARCHAR(255) NOT NULL, created_at timestamp default NULL)'"
    ]
    env:
      PGPASSWORD: postgres
    dependencies:
      - db-dev
  - name: db-populate
    args: [
      psql,
      -w,
      -U, postgres,
      --host, postgres,
      --port=5432,
      -d, postgres,
      -c, "INSERT INTO users (id, name) VALUES (1, 'Peter')"
    ]
    env:
      PGPASSWORD: postgres
    dependencies:
      - db-init
  - name: db-clear
    args: [
      psql,
      -w,
      -U, postgres,
      --host, postgres,
      --port=5432,
      -d, postgres,
      -c, "TRUNCATE users"
    ]
    env:
      PGPASSWORD: postgres
    dependencies:
      - db-dev
values:
  # This is a more digestable name than the default one in the template
  fullnameOverride: postgres
  # This should of course not be used in production
  postgresqlPassword: postgres